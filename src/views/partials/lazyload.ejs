<!-- Cinematic Loading CSS -->
<style>
    .lazy-img {
        opacity: 0;
        transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .lazy-img.loaded {
        opacity: 1;
    }

    .loading-skeleton {
        position: relative;
        overflow: hidden;
        background-color: #1a1625 !important;
    }

    .loading-skeleton::after {
        content: "";
        position: absolute;
        inset: 0;
        transform: translateX(-100%);
        background: linear-gradient(90deg,
                transparent,
                rgba(147, 51, 234, 0.05),
                rgba(147, 51, 234, 0.15),
                rgba(147, 51, 234, 0.05),
                transparent);
        animation: shimmer-effect 2s infinite;
    }

    @keyframes shimmer-effect {
        100% {
            transform: translateX(100%);
        }
    }
</style>

<!-- Standardized Lazy Loading Script -->
<script>
    (function () {
        if (window.lazyLoadInitialized) return;
        window.lazyLoadInitialized = true;

        const lazyConfig = {
            rootMargin: '200px 0px',
            threshold: 0.01
        };

        const lazyObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    const dataSrc = img.dataset.lazySrc || img.dataset.src;

                    if (dataSrc) {
                        const tempImg = new Image();
                        tempImg.onload = function () {
                            img.src = dataSrc;
                            img.classList.add('loaded');

                            // Remove skeleton from parent or itself
                            const container = img.closest('.loading-skeleton') || (img.classList.contains('loading-skeleton') ? img : null);
                            if (container) {
                                // Small delay for smoother transition
                                setTimeout(() => {
                                    container.classList.remove('loading-skeleton');
                                }, 300);
                            }
                        };
                        tempImg.onerror = function () {
                            img.src = '/images/fallback.png';
                            img.classList.add('loaded');
                            const container = img.closest('.loading-skeleton');
                            if (container) container.classList.remove('loading-skeleton');
                        };
                        tempImg.src = dataSrc;
                    }
                    observer.unobserve(img);
                }
            });
        }, lazyConfig);

        function initLazyLoading() {
            // Target all grid images and card covers
            const lazyImages = document.querySelectorAll('img:not(.loaded):not([data-lazy-processed])');

            lazyImages.forEach(img => {
                const originalSrc = img.src;
                if (!originalSrc || originalSrc.includes('fallback.png') || originalSrc.startsWith('data:image')) return;

                // Only process images in grids or cards that look like posters
                const isProcessable = img.closest('.grid') || img.closest('[class*="aspect-"]') || img.classList.contains('hero-img');
                if (!isProcessable) return;

                img.dataset.lazyProcessed = 'true';
                img.dataset.lazySrc = originalSrc;

                // Use a tiny transparent GIF as placeholder
                img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                img.classList.add('lazy-img');

                // Add skeleton to parent for posters/cards
                const container = img.parentElement;
                if (container && (container.classList.contains('aspect-[2/3]') || container.classList.contains('aspect-square') || container.classList.contains('overflow-hidden'))) {
                    container.classList.add('loading-skeleton');
                } else {
                    img.classList.add('loading-skeleton');
                }

                lazyObserver.observe(img);
            });
        }

        // Run on load and after dynamic updates
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initLazyLoading);
        } else {
            initLazyLoading();
        }

        // Expose helper globally
        window.refreshLazyLoading = initLazyLoading;
    })();
</script>