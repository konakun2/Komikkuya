<div class="relative min-h-screen bg-primary-950 overflow-hidden">
    <!-- Background Ambient Glows -->
    <div
        class="absolute top-0 right-0 -translate-y-1/2 translate-x-1/2 w-[800px] h-[800px] bg-purple-600/10 blur-[120px] rounded-full pointer-events-none animate-drift">
    </div>
    <div
        class="absolute bottom-1/4 left-0 -translate-x-1/2 w-[600px] h-[600px] bg-purple-900/10 blur-[100px] rounded-full pointer-events-none animate-swell">
    </div>

    <div class="relative min-h-screen bg-transparent z-10">
        <!-- Full-Bleed Cinematic Hero Section -->
        <div class="relative w-full h-[60vh] min-h-[500px] overflow-hidden">
            <!-- Background Banner -->
            <div class="absolute inset-0 z-0">
                <img src="<%= doujin.cover %>" alt="<%= doujin.title %>"
                    class="w-full h-full object-cover object-center scale-110 blur-[2px] brightness-[0.4] saturate-[1.2]"
                    onerror="this.onerror=null; this.src='/images/fallback.png';">
                <!-- Gradients for depth -->
                <div class="absolute inset-0 bg-gradient-to-t from-primary-900 via-primary-900/60 to-transparent"></div>
                <div class="absolute inset-0 bg-gradient-to-r from-primary-900 via-transparent to-transparent"></div>
            </div>

            <!-- Hero Content Wrapper -->
            <div class="absolute inset-0 z-10 flex flex-col justify-end pb-16 pt-32 md:pt-40">
                <div class="max-w-[1800px] mx-auto px-6 md:px-12 w-full">
                    <div class="flex flex-col md:flex-row gap-10 items-end">
                        <!-- Poster Shadow Box -->
                        <div class="hidden md:block w-64 flex-shrink-0 group/poster">
                            <div class="relative aspect-[2/3] rounded-sm overflow-hidden shadow-[0_20px_50px_rgba(0,0,0,0.8)] border border-white/10 group-hover/poster:scale-105 transition-transform duration-700 bg-primary-800 loading-skeleton"
                                id="posterContainer">
                                <img src="<%= doujin.cover %>" alt="<%= doujin.title %>"
                                    class="w-full h-full object-cover opacity-0 transition-opacity duration-700"
                                    onload="this.classList.remove('opacity-0'); document.getElementById('posterContainer').classList.remove('loading-skeleton')"
                                    onerror="this.onerror=null; this.src='/images/fallback.png'; document.getElementById('posterContainer').classList.remove('loading-skeleton')">
                            </div>
                        </div>

                        <!-- Title & Basic Info -->
                        <div class="flex-1 space-y-6">
                            <div class="space-y-4">
                                <h1
                                    class="text-4xl md:text-7xl font-black text-white uppercase italic tracking-tighter leading-none drop-shadow-2xl">
                                    <%= doujin.title %>
                                </h1>
                                <div class="flex flex-wrap items-center gap-4">
                                    <span
                                        class="px-4 py-1.5 bg-purple-600 text-white text-[10px] font-black uppercase tracking-widest rounded-sm italic">
                                        <%= doujin.type %>
                                    </span>
                                    <span
                                        class="px-4 py-1.5 bg-white/10 backdrop-blur-md text-white text-[10px] font-black uppercase tracking-widest rounded-sm italic border border-white/10">
                                        <%= doujin.status %>
                                    </span>
                                    <span
                                        class="px-4 py-1.5 bg-white/10 backdrop-blur-md text-white text-[10px] font-black uppercase tracking-widest rounded-sm italic border border-white/10">
                                        <%= doujin.author %>
                                    </span>
                                </div>
                            </div>

                            <!-- Mini Glassmorphism Info Grid (Anchored at Hero Bottom) -->
                            <div
                                class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-white/5 backdrop-blur-2xl p-6 rounded-sm border border-white/5 shadow-2xl">
                                <div class="space-y-1">
                                    <span
                                        class="text-[9px] font-black text-white/40 uppercase tracking-widest">Chapters</span>
                                    <p class="text-lg font-black text-white italic">
                                        <%= doujin.totalChapters %>
                                    </p>
                                </div>
                                <div class="space-y-1">
                                    <span
                                        class="text-[9px] font-black text-white/40 uppercase tracking-widest">Update</span>
                                    <p class="text-lg font-black text-white italic">
                                        <%= doujin.lastUpdate %>
                                    </p>
                                </div>
                                <div class="space-y-1">
                                    <span
                                        class="text-[9px] font-black text-white/40 uppercase tracking-widest">Rating</span>
                                    <p class="text-lg font-black text-purple-500 italic">4.9</p>
                                </div>
                                <div class="space-y-1">
                                    <span
                                        class="text-[9px] font-black text-white/40 uppercase tracking-widest">Views</span>
                                    <p class="text-lg font-black text-white italic">HOT</p>
                                </div>
                            </div>

                            <!-- Action Area -->
                            <div class="flex items-center gap-4 pt-4">
                                <% if (doujin.chapters && doujin.chapters.length> 0) { %>
                                    <a href="/doujin/chapter/<%= doujin.chapters[0].slug %>"
                                        class="px-10 py-4 bg-white text-black font-black uppercase text-xs tracking-[0.3em] hover:bg-purple-600 hover:text-white transition-all duration-500 rounded-sm italic shadow-2xl flex items-center gap-3 group">
                                        READ NOW
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                                d="M13 7l5 5-5 5M18 12H6" />
                                        </svg>
                                    </a>
                                    <% } %>

                                        <button id="favoriteButton"
                                            class="px-8 py-4 bg-white/10 backdrop-blur-md border border-white/10 text-white font-black uppercase text-[10px] tracking-[0.3em] hover:bg-white/20 transition-all rounded-sm italic flex items-center gap-3 group shadow-xl">
                                            <svg id="favoriteIcon"
                                                class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none"
                                                stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                            </svg>
                                            <span id="favoriteText">Favorit</span>
                                        </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Section -->
        <main class="relative z-10 max-w-[1800px] mx-auto px-6 md:px-12 py-16">
            <div class="grid lg:grid-cols-12 gap-16">
                <!-- Left Info Area -->
                <div class="lg:col-span-8 space-y-16">
                    <!-- Synopsis Section -->
                    <section class="space-y-8">
                        <div class="flex items-center gap-4">
                            <div class="h-8 w-1.5 bg-purple-600"></div>
                            <h2 class="text-3xl font-black text-white uppercase italic tracking-tighter">Synopsis</h2>
                        </div>
                        <div class="relative group">
                            <div
                                class="absolute -inset-4 bg-gradient-to-br from-purple-600/10 to-transparent rounded-sm opacity-0 group-hover:opacity-100 transition-opacity">
                            </div>
                            <p
                                class="relative text-white/60 leading-relaxed text-lg italic pl-4 border-l border-white/5 group-hover:border-purple-600/30 transition-colors">
                                <%= doujin.description || 'No description available.' %>
                            </p>
                        </div>
                    </section>

                    <!-- Tags Area -->
                    <section class="space-y-6">
                        <div class="flex items-center gap-4">
                            <div class="h-6 w-1 bg-white/20"></div>
                            <h3 class="text-xl font-black text-white/40 uppercase italic tracking-tighter">Tags & Genres
                            </h3>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <% if (doujin.genres && doujin.genres.length> 0) { %>
                                <% doujin.genres.forEach(genre=> { %>
                                    <a href="/genre?genre=<%= genre.toLowerCase() %>"
                                        class="px-6 py-2 bg-white/5 hover:bg-purple-600 text-white/60 hover:text-white text-[10px] font-black uppercase tracking-widest rounded-sm border border-white/5 hover:border-purple-500 transition-all italic">
                                        <%= genre %>
                                    </a>
                                    <% }); %>
                                        <% } %>
                        </div>
                    </section>

                    <!-- Modern Interactive Chapter List -->
                    <section class="space-y-10">
                        <div class="flex flex-col md:flex-row md:items-end justify-between gap-6">
                            <div class="flex items-center gap-4">
                                <div class="h-8 w-1.5 bg-purple-600"></div>
                                <h2 class="text-3xl font-black text-white uppercase italic tracking-tighter">Chapter
                                    List
                                </h2>
                            </div>

                            <!-- List Controls -->
                            <div class="flex items-center gap-4 bg-white/5 p-1 rounded-sm border border-white/5 group">
                                <input type="text" id="chapterSearch" placeholder="SEARCH CHAPTER..."
                                    class="bg-transparent border-none text-[10px] font-black text-white placeholder:text-white/10 px-4 py-2 w-48 focus:ring-0 focus:outline-none uppercase tracking-widest">
                                <button id="sortChapters"
                                    class="p-2 text-white/20 hover:text-white transition-colors border-l border-white/10 group-hover:border-purple-600/30">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Scrollable Modern List -->
                        <div id="chaptersList" class="space-y-2 max-h-[600px] overflow-y-auto pr-2 custom-scrollbar">
                            <% if (doujin.chapters && doujin.chapters.length> 0) { %>
                                <% doujin.chapters.forEach(chapter=> { %>
                                    <a href="/doujin/chapter/<%= chapter.slug %>"
                                        class="group/ch-item flex items-center justify-between p-5 bg-white/[0.02] hover:bg-white/[0.08] border border-transparent hover:border-white/10 rounded-sm transition-all duration-300">
                                        <div class="flex-1 min-w-0">
                                            <h4
                                                class="text-sm font-black text-white/60 group-hover/ch-item:text-white transition-all uppercase italic truncate tracking-tight">
                                                <%= chapter.title %>
                                            </h4>
                                            <div class="flex items-center gap-3 mt-1">
                                                <span
                                                    class="text-[9px] font-black text-white/20 uppercase tracking-[0.2em]">Chapter
                                                    <%= chapter.number %>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="text-right flex items-center gap-4">
                                            <span
                                                class="text-[9px] font-black text-white/10 group-hover/ch-item:text-purple-500 transition-colors uppercase italic tracking-widest">READ</span>
                                            <svg class="w-4 h-4 text-white/10 group-hover/ch-item:text-purple-500 transform group-hover/ch-item:translate-x-1 transition-all"
                                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                                    d="M9 5l7 7-7 7" />
                                            </svg>
                                        </div>
                                    </a>
                                    <% }); %>
                                        <% } else { %>
                                            <div class="text-center py-20 bg-white/5 border border-white/5 rounded-sm">
                                                <p
                                                    class="text-xs font-black text-white/20 uppercase tracking-[0.4em] italic">
                                                    No chapters available</p>
                                            </div>
                                            <% } %>
                        </div>
                    </section>
                </div>

                <!-- Sidebar Info -->
                <div class="lg:col-span-4 space-y-12">
                    <!-- Share Section -->
                    <div
                        class="bg-primary-800/20 backdrop-blur-3xl border border-white/5 p-8 rounded-sm space-y-6 shadow-2xl">
                        <h3 class="text-sm font-black text-white/40 uppercase tracking-widest italic">Share with Friends
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="share('facebook')"
                                class="p-4 bg-[#1877F2]/10 hover:bg-[#1877F2] text-[#1877F2] hover:text-white transition-all rounded-sm flex flex-col items-center gap-2 group">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" />
                                </svg>
                                <span class="text-[9px] font-black uppercase tracking-widest">Facebook</span>
                            </button>
                            <button onclick="share('whatsapp')"
                                class="p-4 bg-[#25D366]/10 hover:bg-[#25D366] text-[#25D366] hover:text-white transition-all rounded-sm flex flex-col items-center gap-2 group">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z" />
                                </svg>
                                <span class="text-[9px] font-black uppercase tracking-widest">WhatsApp</span>
                            </button>
                        </div>
                    </div>

                    <!-- Trending Area placeholder or extra info -->
                    <div
                        class="h-64 bg-white/[0.02] border border-white/5 rounded-sm flex items-center justify-center p-8 text-center">
                        <span class="text-[10px] font-black text-white/10 uppercase tracking-[0.4em] italic">Cinematic
                            Preview Experience</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const favoriteBtn = document.getElementById('favoriteButton');
            const favoriteIcon = document.getElementById('favoriteIcon');
            const favoriteText = document.getElementById('favoriteText');
            const isLoggedIn = <%= typeof user !== 'undefined' && user ? 'true' : 'false' %>;

            const doujinData = {
                id: '<%= doujin.id || doujin.slug %>',
                slug: '<%= doujin.slug %>',
                title: '<%= doujin.title %>',
                cover: '<%= doujin.cover || doujin.thumbnail || doujin.imageUrl %>' || '/images/fallback.png',
                type: 'doujin',
                source: '<%= doujin.source || "Server" %>'
            };

            function updateFavoriteUI(isFavorited) {
                if (!favoriteBtn) return;

                if (isFavorited) {
                    favoriteIcon.setAttribute('fill', 'currentColor');
                    favoriteIcon.classList.add('text-pink-500');
                    favoriteBtn.classList.add('bg-pink-600/20', 'border-pink-500/30');
                    favoriteText.textContent = 'Favorited';
                } else {
                    favoriteIcon.setAttribute('fill', 'none');
                    favoriteIcon.classList.remove('text-pink-500');
                    favoriteBtn.classList.remove('bg-pink-600/20', 'border-pink-500/30');
                    favoriteText.textContent = 'Favorit';
                }
            }

            async function checkFavoriteStatus() {
                const favorites = JSON.parse(localStorage.getItem('komikkuya_favorites') || '[]');
                let isFavorited = favorites.some(item => item.id === doujinData.id);

                // If logged in, prioritize cloud check
                if (isLoggedIn) {
                    try {
                        const response = await fetch(`/auth/favorites/check/${encodeURIComponent(doujinData.id)}`);
                        const data = await response.json();
                        console.log('[Favorite Check]', doujinData.id, data);

                        if (data.success) {
                            // Handle various response formats: data.favorited, data.data.favorited, data.data.isFavorite
                            isFavorited = data.favorited ?? data.data?.favorited ?? data.data?.isFavorite ?? false;
                        }
                    } catch (e) {
                        console.error('Failed to check cloud favorite:', e);
                    }
                }

                updateFavoriteUI(isFavorited);
                return isFavorited;
            }

            if (favoriteBtn) {
                favoriteBtn.addEventListener('click', async function () {
                    let favorites = JSON.parse(localStorage.getItem('komikkuya_favorites') || '[]');
                    const index = favorites.findIndex(item => item.id === doujinData.id);
                    const wasAdded = index === -1;

                    if (index > -1) {
                        favorites.splice(index, 1);
                    } else {
                        favorites.push(doujinData);
                    }

                    localStorage.setItem('komikkuya_favorites', JSON.stringify(favorites));
                    updateFavoriteUI(wasAdded);

                    if (isLoggedIn) {
                        try {
                            if (wasAdded) {
                                await fetch('/auth/favorites', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(doujinData)
                                });
                            } else {
                                await fetch(`/auth/favorites/${doujinData.id}`, {
                                    method: 'DELETE'
                                });
                            }
                        } catch (e) {
                            console.error('Failed to sync favorite:', e);
                        }
                    }
                });

                checkFavoriteStatus();
            }

            const searchInput = document.getElementById('chapterSearch');
            const sortButton = document.getElementById('sortChapters');
            const chaptersList = document.getElementById('chaptersList');
            let isAscending = false;

            // Search logic
            searchInput.addEventListener('input', function () {
                const query = this.value.toUpperCase();
                const items = chaptersList.querySelectorAll('a');
                items.forEach(item => {
                    const title = item.querySelector('h4').textContent.toUpperCase();
                    item.style.display = title.includes(query) ? '' : 'none';
                });
            });

            // Sort logic
            sortButton.addEventListener('click', function () {
                const chapters = Array.from(chaptersList.querySelectorAll('a'));
                if (chapters.length === 0) return;

                chapters.sort((a, b) => {
                    const titleA = a.querySelector('h4').textContent;
                    const titleB = b.querySelector('h4').textContent;
                    const numA = parseFloat(titleA.match(/\d+(\.\d+)?/)?.[0] || 0);
                    const numB = parseFloat(titleB.match(/\d+(\.\d+)?/)?.[0] || 0);
                    return isAscending ? numA - numB : numB - numA;
                });

                chapters.forEach(ch => chaptersList.appendChild(ch));
                isAscending = !isAscending;
                sortButton.style.transform = isAscending ? 'rotate(180deg)' : 'rotate(0deg)';
            });

            // Server link persistence
            const preferredServer = localStorage.getItem('doujinServer') || '1';
            chaptersList.querySelectorAll('a').forEach(link => {
                const href = link.getAttribute('href');
                if (href && !href.includes('?server=')) {
                    link.setAttribute('href', href + '?server=' + preferredServer);
                }
            });
        });

        function share(platform) {
            const url = window.location.href;
            const text = document.title;
            if (platform === 'facebook') window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
            if (platform === 'whatsapp') window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(text + ' ' + url)}`, '_blank');
        }
    </script>

</div>
</div>

<style>
    @keyframes drift {

        0%,
        100% {
            transform: translate(50%, -50%) scale(1);
        }

        50% {
            transform: translate(45%, -45%) scale(1.1);
        }
    }

    @keyframes swell {

        0%,
        100% {
            transform: translate(-50%, 0) scale(1);
            opacity: 0.4;
        }

        50% {
            transform: translate(-45%, 5%) scale(1.15);
            opacity: 0.6;
        }
    }

    .animate-drift {
        animation: drift 20s ease-in-out infinite;
    }

    .animate-swell {
        animation: swell 25s ease-in-out infinite;
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #9333ea;
        border-radius: 0;
    }

    .loading-skeleton {
        position: relative;
        overflow: hidden;
    }

    .loading-skeleton::after {
        content: "";
        position: absolute;
        inset: 0;
        transform: translateX(-100%);
        background: linear-gradient(90deg,
                transparent,
                rgba(147, 51, 234, 0.1),
                rgba(147, 51, 234, 0.2),
                rgba(147, 51, 234, 0.1),
                transparent);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        100% {
            transform: translateX(100%);
        }
    }
</style>

<%- include('../partials/lazyload') %>