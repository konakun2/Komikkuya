<div class="relative min-h-screen bg-primary-950 overflow-hidden">
    <!-- Background Ambient Glows -->
    <div
        class="absolute top-0 right-0 -translate-y-1/2 translate-x-1/2 w-[800px] h-[800px] bg-purple-600/10 blur-[120px] rounded-full pointer-events-none">
    </div>
    <div
        class="absolute bottom-0 left-0 translate-y-1/2 -translate-x-1/2 w-[600px] h-[600px] bg-purple-900/10 blur-[100px] rounded-full pointer-events-none">
    </div>

    <div class="max-w-[1800px] mx-auto px-6 md:px-12 relative z-10 pt-32 pb-20">
        <!-- Mega Header Section -->
        <header class="relative mb-20">
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-8">
                <div class="space-y-4 animate-fade-in">
                    <div class="flex items-center gap-3 text-pink-500 font-black tracking-[0.3em] uppercase text-xs">
                        <span class="w-12 h-[2px] bg-pink-500"></span>
                        YOUR COLLECTION
                    </div>
                    <h1
                        class="text-6xl md:text-8xl font-black text-white italic tracking-tighter uppercase leading-none">
                        My <br><span class="text-transparent stroke-text">Favorites</span>
                    </h1>
                </div>

                <div class="flex items-center gap-6 animate-fade-in" style="animation-delay: 200ms">
                    <div class="group relative px-8 py-4 bg-white/5 backdrop-blur-xl border border-white/10 rounded-sm">
                        <div
                            class="absolute inset-0 bg-pink-600/10 opacity-0 group-hover:opacity-100 transition-opacity">
                        </div>
                        <div class="relative flex flex-col">
                            <span id="favoritesCount"
                                class="text-4xl font-black text-white italic leading-none mb-1">0</span>
                            <span class="text-[9px] font-black text-white/30 uppercase tracking-[0.2em]">Saved
                                Treasures</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dynamic Grid -->
        <main id="favoritesGrid"
            class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6 md:gap-10 min-h-[400px]">
            <!-- Skeleton State -->
            <% for(let i=0; i<12; i++) { %>
                <div class="favorite-skeleton space-y-4 animate-pulse">
                    <div class="aspect-[2/3] bg-white/5 rounded-sm border border-white/5"></div>
                    <div class="h-4 bg-white/5 rounded-sm w-3/4"></div>
                    <div class="h-3 bg-white/5 rounded-sm w-1/2"></div>
                </div>
                <% } %>
        </main>

        <!-- Premium Empty State -->
        <div id="emptyState"
            class="hidden flex flex-col items-center justify-center py-48 text-center space-y-12 animate-fade-in">
            <div class="relative group">
                <div
                    class="absolute inset-0 bg-pink-600/20 blur-[60px] group-hover:bg-pink-600/40 transition-all rounded-full">
                </div>
                <div
                    class="relative w-40 h-40 bg-white/5 rounded-full flex items-center justify-center border border-white/5 backdrop-blur-2xl">
                    <svg class="w-20 h-20 text-white/10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                            d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                    </svg>
                </div>
            </div>
            <div class="space-y-4">
                <h2 class="text-5xl font-black text-white italic uppercase tracking-tighter">Your Heart is Empty</h2>
                <p class="text-white/40 font-medium max-w-sm mx-auto">Bos belum ada favorit komik nih. Cari komik mantap
                    terus sikat pencet tombol favorit-nya!</p>
            </div>
            <a href="/popular"
                class="inline-flex items-center px-12 py-5 bg-pink-600 hover:bg-pink-700 text-white text-[10px] font-black uppercase tracking-[0.3em] rounded-sm transition-all shadow-[0_30px_60px_rgba(219,39,119,0.4)] hover:-translate-y-1 italic">
                Start Exploring
            </a>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const grid = document.getElementById('favoritesGrid');
        const emptyState = document.getElementById('emptyState');
        const countDisplay = document.getElementById('favoritesCount');
        const isLoggedIn = <%= typeof user !== 'undefined' && user ? 'true' : 'false' %>;

        const wsrvUrl = (url) => {
            if (!url) return '/images/fallback.png';
            if (url.startsWith('http')) {
                return `https://wsrv.nl/?url=${encodeURIComponent(url)}&n=-1`;
            }
            return url;
        };

        // Load from localStorage
        function loadLocalFavorites() {
            try {
                return JSON.parse(localStorage.getItem('komikkuya_favorites') || '[]');
            } catch (e) { return []; }
        }

        // Load from cloud
        async function loadCloudFavorites() {
            try {
                const response = await fetch('/auth/favorites');
                const data = await response.json();
                if (data.success && data.data) {
                    return data.data;
                }
                return [];
            } catch (e) {
                console.error('Failed to load cloud favorites:', e);
                return [];
            }
        }

        // Sync localStorage to cloud
        async function syncLocalToCloud() {
            if (!isLoggedIn) return;

            const localFavorites = loadLocalFavorites();
            if (localFavorites.length === 0) return;

            console.log('[Favorites] Syncing localStorage to cloud...');
            for (const item of localFavorites) {
                try {
                    await fetch('/auth/favorites', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(item)
                    });
                } catch (e) {
                    console.error('Failed to sync item:', e);
                }
            }
            console.log('[Favorites] Cloud sync complete!');
        }

        // Main load function
        async function loadFavorites() {
            if (isLoggedIn) {
                await syncLocalToCloud();
                return await loadCloudFavorites();
            }
            return loadLocalFavorites();
        }

        async function renderFavorites() {
            const favorites = await loadFavorites();

            grid.innerHTML = '';
            countDisplay.textContent = favorites.length;

            if (favorites.length === 0) {
                grid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            grid.classList.remove('hidden');
            emptyState.classList.add('hidden');

            favorites.forEach((item, index) => {
                const url = item.type === 'doujin' ? `/doujin/${item.slug}` : `/manga/${item.slug}`;
                const typeBadge = item.type === 'doujin'
                    ? '<span class="bg-red-600/90 text-white text-[8px] font-black px-1.5 py-0.5 rounded-px uppercase tracking-tighter">NSFW</span>'
                    : '<span class="bg-pink-600/90 text-white text-[8px] font-black px-1.5 py-0.5 rounded-px uppercase tracking-tighter">Manga</span>';

                const card = document.createElement('div');
                card.className = 'group relative flex flex-col gap-4 animate-fade-in';
                card.style.animationDelay = `${index * 50}ms`;

                card.innerHTML = `
                <div class="relative aspect-[2/3] overflow-hidden rounded-sm border border-white/5 shadow-2xl transition-all duration-700 group-hover:scale-102 group-hover:border-pink-500/50 bg-primary-800">
                    <img src="${item.cover}" alt="${item.title}" 
                        class="w-full h-full object-cover grayscale-[0.3] group-hover:grayscale-0 transition-all duration-1000 scale-110 group-hover:scale-100"
                        onerror="if(this.src === '${item.cover}'){this.src='https://wsrv.nl/?url=' + encodeURIComponent('${item.cover}') + '&n=-1';}else if(this.src.includes('wsrv.nl')){this.src='/images/fallback.png';}">
                    
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-80 group-hover:opacity-40 transition-opacity duration-700"></div>
                    
                    <div class="absolute top-3 left-3 flex flex-col gap-1.5 opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-500">
                        ${typeBadge}
                        <span class="bg-black/80 backdrop-blur-md text-white/60 text-[8px] font-black px-1.5 py-0.5 rounded-px uppercase tracking-tighter border border-white/5">
                            ${item.source || 'Standard'}
                        </span>
                    </div>

                    <button onclick="event.preventDefault(); removeFavorite('${item.id}');" 
                        class="absolute top-3 right-3 opacity-0 translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-500 p-2 bg-red-600/90 hover:bg-red-700 text-white rounded-sm drop-shadow-xl z-20">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>

                    <a href="${url}" class="absolute inset-0 z-10"></a>
                </div>

                <div class="space-y-1.5">
                    <div class="flex items-center gap-2">
                        <span class="text-pink-500 text-[9px] font-black uppercase tracking-widest leading-none">Saved Item</span>
                        <div class="h-[1px] flex-grow bg-white/5"></div>
                    </div>
                    <h3 class="text-white font-black uppercase text-xs italic tracking-tight truncate group-hover:text-pink-400 transition-colors leading-tight">
                        ${item.title}
                    </h3>
                </div>
            `;
                grid.appendChild(card);
            });
        }

        window.removeFavorite = async function (id) {
            // Remove from localStorage
            let favorites = loadLocalFavorites();
            favorites = favorites.filter(item => item.id !== id);
            localStorage.setItem('komikkuya_favorites', JSON.stringify(favorites));

            // Remove from cloud if logged in
            if (isLoggedIn) {
                try {
                    await fetch(`/auth/favorites/${id}`, {
                        method: 'DELETE'
                    });
                } catch (e) {
                    console.error('Failed to remove from cloud:', e);
                }
            }

            await renderFavorites();
        };

        await renderFavorites();
    });
</script>

<style>
    .stroke-text {
        -webkit-text-stroke: 1px rgba(255, 255, 255, 0.1);
    }

    @keyframes fade-in {
        from {
            opacity: 0;
            transform: translateY(15px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in {
        animation: fade-in 1s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    .scale-102 {
        transform: scale(1.02);
    }
</style>