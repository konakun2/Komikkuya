<div class="relative min-h-screen bg-primary-950">
  <!-- Mega Header Section -->
  <div class="relative pt-32 pb-16 overflow-hidden">
    <!-- Background Ambient Glow -->
    <div
      class="absolute top-0 right-0 -translate-y-1/2 translate-x-1/2 w-[800px] h-[800px] bg-purple-600/10 blur-[120px] rounded-full pointer-events-none">
    </div>
    <div
      class="absolute bottom-0 left-0 translate-y-1/2 -translate-x-1/2 w-[600px] h-[600px] bg-purple-900/10 blur-[100px] rounded-full pointer-events-none">
    </div>

    <div class="max-w-[1800px] mx-auto px-6 md:px-12 relative z-10">
      <div class="flex flex-col md:flex-row md:items-end justify-between gap-8">
        <div class="space-y-4">
          <div class="flex items-center gap-3 text-purple-500 font-black tracking-[0.3em] uppercase text-xs">
            <span class="w-12 h-[2px] bg-purple-500"></span>
            YOUR VIBE
          </div>
          <h1 class="text-6xl md:text-8xl font-black text-white italic tracking-tighter uppercase leading-none">
            Reading<br><span class="text-transparent stroke-text">History</span>
          </h1>
          <p class="text-white/40 max-w-xl text-lg font-medium leading-relaxed">
            Lacak perjalanan membaca kamu bos. Semua jejak "petualangan" kamu tersimpan rapi di sini, privat dan aman di
            browser kamu.
          </p>
        </div>

        <div class="flex items-center gap-4">
          <button id="clearAllHistory"
            class="group flex items-center gap-3 px-8 py-5 bg-white/5 hover:bg-red-600/20 border border-white/10 hover:border-red-500/50 rounded-sm transition-all duration-500">
            <svg class="w-5 h-5 text-white/60 group-hover:text-red-500 transition-colors" fill="none"
              stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            <span
              class="text-xs font-black uppercase tracking-widest text-white/60 group-hover:text-white transition-colors">Clear
              Records</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <main class="max-w-[1800px] mx-auto px-6 md:px-12 pb-32">
    <div id="history-container"
      class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6 md:gap-8">
      <!-- Initial Shimmer State -->
      <% for(let i=0; i<12; i++) { %>
        <div class="space-y-4 animate-pulse">
          <div class="aspect-[2/3] bg-white/5 rounded-sm"></div>
          <div class="h-4 bg-white/5 w-3/4 rounded-sm"></div>
          <div class="h-3 bg-white/5 w-1/2 rounded-sm"></div>
        </div>
        <% } %>
    </div>
  </main>
</div>

<!-- Premium Delete Modal -->
<div id="deleteModal"
  class="fixed inset-0 z-[200] flex items-center justify-center p-6 opacity-0 pointer-events-none transition-all duration-500">
  <div class="absolute inset-0 bg-black/95 backdrop-blur-2xl"></div>
  <div
    class="relative w-full max-w-lg bg-primary-900 border border-white/10 p-12 rounded-sm transform scale-95 transition-transform duration-500">
    <div class="space-y-8 text-center">
      <div class="w-24 h-24 bg-red-600/20 rounded-full flex items-center justify-center mx-auto ring-1 ring-red-500/30">
        <svg class="w-12 h-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
      </div>
      <div class="space-y-2">
        <h3 class="text-4xl font-black text-white italic uppercase tracking-tighter">Hapus Item?</h3>
        <p class="text-white/40 font-medium">Yakin bos mau buang ini dari memori?</p>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <button id="cancelDelete"
          class="py-5 bg-white/5 hover:bg-white/10 text-white text-[10px] font-black uppercase tracking-widest transition-all rounded-sm border border-white/10">Nanti
          Dulu</button>
        <button id="confirmDelete"
          class="py-5 bg-red-600 hover:bg-red-700 text-white text-[10px] font-black uppercase tracking-widest transition-all rounded-sm shadow-[0_20px_40px_rgba(220,38,38,0.3)]">Ya,
          Hapus!</button>
      </div>
    </div>
  </div>
</div>

<!-- Premium Clear All Modal -->
<div id="clearAllModal"
  class="fixed inset-0 z-[200] flex items-center justify-center p-6 opacity-0 pointer-events-none transition-all duration-500">
  <div class="absolute inset-0 bg-black/95 backdrop-blur-2xl"></div>
  <div
    class="relative w-full max-w-lg bg-primary-900 border border-white/10 p-12 rounded-sm transform scale-95 transition-transform duration-500">
    <div class="space-y-8 text-center">
      <div class="w-24 h-24 bg-red-600/20 rounded-full flex items-center justify-center mx-auto ring-1 ring-red-500/30">
        <svg class="w-12 h-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
      </div>
      <div class="space-y-2">
        <h3 class="text-4xl font-black text-white italic uppercase tracking-tighter">WIPE ALL?</h3>
        <p class="text-white/40 font-medium">History bakal hilang permanen bos. Serius nih?</p>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <button id="cancelClearAll"
          class="py-5 bg-white/5 hover:bg-white/10 text-white text-[10px] font-black uppercase tracking-widest transition-all rounded-sm border border-white/10">Batalkan</button>
        <button id="confirmClearAll"
          class="py-5 bg-red-600 hover:bg-red-700 text-white text-[10px] font-black uppercase tracking-widest transition-all rounded-sm shadow-[0_20px_40px_rgba(220,38,38,0.3)]">Sikat
          Bersih!</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const historyContainer = document.getElementById('history-container');
    const deleteModal = document.getElementById('deleteModal');
    const clearAllModal = document.getElementById('clearAllModal');
    const cancelDelete = document.getElementById('cancelDelete');
    const confirmDelete = document.getElementById('confirmDelete');
    const cancelClearAll = document.getElementById('cancelClearAll');
    const confirmClearAll = document.getElementById('confirmClearAll');
    const clearAllBtn = document.getElementById('clearAllHistory');

    let currentDeleteIndex = -1;
    let currentDeleteTitle = '';
    const isLoggedIn = <%= typeof user !== 'undefined' && user ? 'true' : 'false' %>;

    const wsrvUrl = (url) => {
      if (!url) return '/images/fallback.png';
      if (url.startsWith('http')) {
        return `https://wsrv.nl/?url=${encodeURIComponent(url)}&n=-1`;
      }
      return url;
    };

    // Load history from localStorage
    function loadLocalHistory() {
      try {
        const history = JSON.parse(localStorage.getItem('readingHistory') || '[]');
        return history.sort((a, b) => b.time - a.time);
      } catch (e) { return []; }
    }

    // Load history from database
    async function loadCloudHistory() {
      try {
        const response = await fetch('/auth/reading-history');
        const data = await response.json();
        if (data.success && data.data) {
          return data.data.sort((a, b) => b.time - a.time);
        }
        return [];
      } catch (e) {
        console.error('Failed to load cloud history:', e);
        return [];
      }
    }

    // Sync localStorage to cloud (on login)
    async function syncLocalToCloud() {
      if (!isLoggedIn) return;

      const localHistory = loadLocalHistory();
      if (localHistory.length === 0) return;

      console.log('[History] Syncing localStorage to cloud...');
      for (const item of localHistory) {
        try {
          await fetch('/auth/reading-history', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(item)
          });
        } catch (e) {
          console.error('Failed to sync item:', e);
        }
      }
      console.log('[History] Cloud sync complete!');
    }

    // Main load function
    async function loadHistory() {
      if (isLoggedIn) {
        // Sync localStorage to cloud first
        await syncLocalToCloud();
        return await loadCloudHistory();
      }
      return loadLocalHistory();
    }

    function formatDate(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

      if (diffDays === 0) return 'Tadi';
      if (diffDays === 1) return 'Kemarin';
      if (diffDays < 7) return `${diffDays} hari lalu`;
      return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
    }

    function showModal(modal) {
      modal.classList.remove('opacity-0', 'pointer-events-none');
      modal.querySelector('.relative').classList.remove('scale-95');
      modal.querySelector('.relative').classList.add('scale-100');
    }

    function hideModal(modal) {
      modal.classList.add('opacity-0', 'pointer-events-none');
      modal.querySelector('.relative').classList.add('scale-95');
      modal.querySelector('.relative').classList.remove('scale-100');
    }

    async function updateDisplay() {
      const history = await loadHistory();

      if (history.length === 0) {
        historyContainer.innerHTML = `
                <div class="col-span-full py-48 text-center space-y-10 animate-fade-in">
                    <div class="relative group mx-auto w-40 h-40">
                        <div class="absolute inset-0 bg-purple-600/30 blur-[60px] group-hover:bg-purple-600/50 transition-all rounded-full"></div>
                        <div class="relative w-40 h-40 bg-white/5 rounded-full flex items-center justify-center border border-white/5 backdrop-blur-xl">
                            <svg class="w-20 h-20 text-white/10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                            </svg>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h2 class="text-5xl font-black text-white italic uppercase tracking-tighter">History Masih Bersih</h2>
                        <p class="text-white/40 font-medium max-w-md mx-auto">Bos belum ada baca apa-apa nih. Yuk cari komik mantap dulu buat di-history-in!</p>
                    </div>
                    <a href="/popular" class="inline-flex items-center px-12 py-5 bg-purple-600 hover:bg-purple-700 text-white text-xs font-black uppercase tracking-[0.2em] rounded-sm transition-all shadow-[0_30px_60px_rgba(147,51,234,0.4)] hover:-translate-y-1">
                        Find Something to Read
                    </a>
                </div>
            `;
        return;
      }

      historyContainer.innerHTML = history.map((item, index) => {
        const typeBadge = item.type === 'doujin'
          ? '<span class="bg-red-600/90 text-white text-[8px] font-black px-1.5 py-0.5 rounded-px uppercase tracking-tighter">NSFW</span>'
          : '<span class="bg-purple-600/90 text-white text-[8px] font-black px-1.5 py-0.5 rounded-px uppercase tracking-tighter">Manga</span>';

        return `
            <div class="group relative flex flex-col gap-4 animate-fade-in" style="animation-delay: ${index * 50}ms">
                <a href="${item.url}" class="block">
                    <div class="relative aspect-[2/3] overflow-hidden rounded-sm border border-white/5 shadow-2xl transition-all duration-700 group-hover:scale-102 group-hover:border-purple-500/50 bg-primary-800">
                        <img src="${item.image}" alt="${item.title}"
                            class="w-full h-full object-cover grayscale-[0.2] group-hover:grayscale-0 transition-all duration-1000 scale-110 group-hover:scale-100"
                            loading="lazy" 
                            onerror="if(this.src === '${item.image}'){this.src='https://wsrv.nl/?url=' + encodeURIComponent('${item.image}') + '&n=-1';}else if(this.src.includes('wsrv.nl')){this.src='/images/fallback.png';}">
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-80 group-hover:opacity-40 transition-opacity duration-700"></div>
                        <div class="absolute top-3 left-3 flex flex-col gap-1.5">
                            ${typeBadge}
                        </div>
                        <button class="delete-item absolute top-3 right-3 w-8 h-8 bg-black/70 hover:bg-red-600 border border-white/10 hover:border-red-500 rounded-sm flex items-center justify-center opacity-0 -translate-y-2 group-hover:opacity-100 group-hover:translate-y-0 transition-all duration-500 z-20"
                            data-index="${index}" data-title="${item.title}">
                            <svg class="w-4 h-4 text-white/60 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                        <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 to-transparent">
                            <span class="text-[9px] font-black text-purple-400 uppercase tracking-widest">${formatDate(item.time)}</span>
                        </div>
                    </div>
                </a>
                <div class="space-y-2">
                    <div class="flex items-center gap-2">
                        <span class="text-purple-500 text-[9px] font-black uppercase tracking-widest leading-none">Last Read</span>
                        <div class="h-[1px] flex-grow bg-white/5"></div>
                    </div>
                    <h3 class="text-white font-black uppercase text-xs italic tracking-tight truncate group-hover:text-purple-400 transition-colors leading-tight">
                        ${item.title}
                    </h3>
                    <p class="text-white/30 text-[10px] font-bold truncate tracking-widest uppercase">
                       ${item.chapterTitle || item.chapter_title || ''}
                    </p>
                </div>
            </div>
        `}).join('');

      // Bind Events
      document.querySelectorAll('.delete-item').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          e.preventDefault();
          currentDeleteIndex = parseInt(btn.dataset.index);
          currentDeleteTitle = btn.dataset.title;
          showModal(deleteModal);
        });
      });
    }

    confirmDelete.addEventListener('click', async () => {
      if (currentDeleteIndex !== -1) {
        // Delete from localStorage
        const localHistory = loadLocalHistory();
        localHistory.splice(currentDeleteIndex, 1);
        localStorage.setItem('readingHistory', JSON.stringify(localHistory));

        // Delete from cloud if logged in
        if (isLoggedIn && currentDeleteTitle) {
          try {
            await fetch('/auth/reading-history', {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ title: currentDeleteTitle })
            });
          } catch (e) {
            console.error('Failed to delete from cloud:', e);
          }
        }

        await updateDisplay();
        hideModal(deleteModal);
      }
    });

    clearAllBtn.addEventListener('click', () => showModal(clearAllModal));
    confirmClearAll.addEventListener('click', async () => {
      // Clear localStorage
      localStorage.setItem('readingHistory', '[]');

      // Clear cloud if logged in
      if (isLoggedIn) {
        try {
          await fetch('/auth/reading-history/all', {
            method: 'DELETE'
          });
        } catch (e) {
          console.error('Failed to clear cloud history:', e);
        }
      }

      await updateDisplay();
      hideModal(clearAllModal);
    });

    cancelDelete.addEventListener('click', () => hideModal(deleteModal));
    cancelClearAll.addEventListener('click', () => hideModal(clearAllModal));

    await updateDisplay();
  });
</script>

<style>
  .stroke-text {
    -webkit-text-stroke: 1px rgba(255, 255, 255, 0.1);
  }

  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(15px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fade-in 1s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  .scale-102 {
    transform: scale(1.02);
  }
</style>